<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Booking Status Fix Test</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
		/>
		<style>
			body {
				padding: 2rem;
				background-color: #f8f9fa;
			}
			.test-container {
				max-width: 800px;
				margin: 0 auto;
			}
			.status-test-card {
				margin-bottom: 2rem;
			}
			.test-result {
				margin-top: 1rem;
				padding: 1rem;
				border-radius: 0.375rem;
			}
			.test-result.success {
				background-color: #d1e7dd;
				border: 1px solid #badbcc;
				color: #0f5132;
			}
			.test-result.error {
				background-color: #f8d7da;
				border: 1px solid #f5c2c7;
				color: #842029;
			}
			.event-log {
				background-color: #fff;
				border: 1px solid #dee2e6;
				border-radius: 0.375rem;
				padding: 1rem;
				max-height: 200px;
				overflow-y: auto;
			}
			.log-entry {
				font-family: monospace;
				font-size: 0.875rem;
				margin-bottom: 0.25rem;
			}
			.log-entry.info {
				color: #0969da;
			}
			.log-entry.warning {
				color: #9a6700;
			}
			.log-entry.error {
				color: #cf222e;
			}
		</style>
	</head>
	<body>
		<div class="test-container">
			<h1 class="mb-4">
				<i class="fas fa-bug-slash text-success"></i>
				Booking Status Update Fix Test
			</h1>

			<div class="alert alert-info">
				<h5><i class="fas fa-info-circle"></i> Test Overview</h5>
				<p class="mb-0">
					This test verifies that the booking status update fix
					prevents multiple confirmation alerts when changing booking
					status. Only ONE confirmation dialog should appear when you
					change the status.
				</p>
			</div>

			<div class="card status-test-card">
				<div class="card-header">
					<h5>
						<i class="fas fa-calendar-check text-primary"></i> Test
						Booking - Sample Status Update
					</h5>
				</div>
				<div class="card-body">
					<div class="row">
						<div class="col-md-6">
							<h6>Booking Information</h6>
							<ul class="list-unstyled">
								<li><strong>Booking ID:</strong> #12345</li>
								<li>
									<strong>Customer:</strong> Test Customer
								</li>
								<li><strong>Date:</strong> 2025-06-15</li>
								<li><strong>Time:</strong> 19:00</li>
								<li><strong>Guests:</strong> 4</li>
							</ul>
						</div>
						<div class="col-md-6">
							<h6>Status Update Test</h6>
							<div class="mb-3">
								<label for="testStatusSelect" class="form-label"
									>Change Status:</label
								>
								<select
									class="form-select form-select-sm status-select"
									id="testStatusSelect"
									data-booking-id="12345"
									data-current-status="pending"
								>
									<option value="pending" selected>
										Pending
									</option>
									<option value="confirmed">Confirmed</option>
									<option value="completed">Completed</option>
									<option value="cancelled">Cancelled</option>
								</select>
							</div>
							<div class="alert alert-warning alert-sm">
								<i class="fas fa-exclamation-triangle"></i>
								<small
									>Changing this status should show only ONE
									confirmation dialog.</small
								>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="card">
				<div class="card-header">
					<h5>
						<i class="fas fa-clipboard-list text-info"></i> Test
						Results & Event Log
					</h5>
				</div>
				<div class="card-body">
					<div
						id="testResult"
						class="test-result"
						style="display: none"
					></div>

					<h6>Event Log:</h6>
					<div id="eventLog" class="event-log">
						<div class="log-entry info">
							Test initialized - Ready for testing
						</div>
					</div>

					<div class="mt-3">
						<button
							class="btn btn-primary btn-sm"
							onclick="clearLog()"
						>
							<i class="fas fa-trash"></i> Clear Log
						</button>
						<button
							class="btn btn-success btn-sm"
							onclick="runAutomatedTest()"
						>
							<i class="fas fa-play"></i> Run Automated Test
						</button>
					</div>
				</div>
			</div>

			<div class="card mt-4">
				<div class="card-header">
					<h5>
						<i class="fas fa-check-circle text-success"></i> Fix
						Summary
					</h5>
				</div>
				<div class="card-body">
					<h6>Problem:</h6>
					<ul>
						<li>
							Multiple event listeners were attached to
							<code>.status-select</code> elements
						</li>
						<li>
							<code>initializeStatusUpdates()</code> and
							<code>initializeBulkBookingSelection()</code> both
							added listeners
						</li>
						<li>
							Booking index page also called
							<code>initializeBookingManagement()</code> directly
						</li>
						<li>
							Result: 2-3 confirmation dialogs appeared for each
							status change
						</li>
					</ul>

					<h6>Solution:</h6>
					<ul>
						<li>
							Added duplicate prevention using
							<code>data-*-listener-added</code> attributes
						</li>
						<li>
							Removed redundant
							<code>initializeBookingManagement()</code> call from
							booking index page
						</li>
						<li>
							Kept global initialization in admin.js for
							consistent behavior
						</li>
					</ul>
				</div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

		<!-- Simulate the admin.js functionality for testing -->
		<script>
			// Simulate window configuration
			window.SITE_URL = 'http://localhost/buffet_booking_mvc';
			window.adminConfig = {
				csrfToken: 'test-csrf-token',
				initialized: false,
			};

			let eventCount = 0;
			let confirmationCount = 0;

			// Mock functions for testing
			function logEvent(message, type = 'info') {
				const log = document.getElementById('eventLog');
				const entry = document.createElement('div');
				entry.className = `log-entry ${type}`;
				entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
				log.appendChild(entry);
				log.scrollTop = log.scrollHeight;
			}

			function clearLog() {
				document.getElementById('eventLog').innerHTML =
					'<div class="log-entry info">Log cleared - Ready for testing</div>';
				eventCount = 0;
				confirmationCount = 0;
				document.getElementById('testResult').style.display = 'none';
			}

			// Mock the fixed admin.js functions with duplicate prevention
			function initializeStatusUpdates() {
				const statusSelects =
					document.querySelectorAll('.status-select');
				logEvent(
					`Found ${statusSelects.length} status select elements`
				);

				statusSelects.forEach((select, index) => {
					// Check if listener already added to prevent duplicates
					if (select.hasAttribute('data-status-listener-added')) {
						logEvent(
							`Skipping element ${
								index + 1
							} - listener already added`,
							'warning'
						);
						return;
					}

					// Mark as having listener added
					select.setAttribute('data-status-listener-added', 'true');
					logEvent(
						`Adding status update listener to element ${index + 1}`
					);

					select.addEventListener('change', function () {
						eventCount++;
						logEvent(
							`Status update event fired (Event #${eventCount})`
						);

						const bookingId = this.dataset.bookingId;
						const newStatus = this.value;
						const currentStatus = this.dataset.currentStatus;

						if (newStatus !== currentStatus) {
							updateStatus(bookingId, newStatus, this);
						}
					});
				});
			}

			function initializeBulkBookingSelection() {
				const statusSelects =
					document.querySelectorAll('.status-select');
				logEvent(
					`Bulk selection checking ${statusSelects.length} status select elements`
				);

				statusSelects.forEach((select, index) => {
					// Skip if listener already added to prevent duplicates
					if (
						select.hasAttribute(
							'data-booking-status-listener-added'
						)
					) {
						logEvent(
							`Skipping bulk element ${
								index + 1
							} - booking listener already added`,
							'warning'
						);
						return;
					}

					// Mark as having booking status listener added
					select.setAttribute(
						'data-booking-status-listener-added',
						'true'
					);
					logEvent(
						`Adding booking status listener to element ${index + 1}`
					);

					select.addEventListener('change', function () {
						eventCount++;
						logEvent(
							`Booking status event fired (Event #${eventCount})`
						);

						const bookingId = this.dataset.bookingId;
						const newStatus = this.value;
						const originalStatus = this.dataset.currentStatus;

						if (newStatus !== originalStatus) {
							updateBookingStatus(bookingId, newStatus);
						}
					});
				});
			}

			function updateStatus(bookingId, newStatus, selectElement) {
				confirmationCount++;
				logEvent(
					`updateStatus called (Confirmation #${confirmationCount}) - Booking: ${bookingId}, Status: ${newStatus}`,
					'info'
				);

				const confirmed = confirm(
					`updateStatus: Are you sure you want to change booking #${bookingId} status to "${newStatus}"?`
				);
				if (confirmed) {
					logEvent(
						`Status update confirmed via updateStatus`,
						'info'
					);
					selectElement.dataset.currentStatus = newStatus;
					showTestResult();
				} else {
					logEvent(
						`Status update cancelled via updateStatus`,
						'warning'
					);
					selectElement.value = selectElement.dataset.currentStatus;
				}
			}

			function updateBookingStatus(bookingId, newStatus) {
				confirmationCount++;
				logEvent(
					`updateBookingStatus called (Confirmation #${confirmationCount}) - Booking: ${bookingId}, Status: ${newStatus}`,
					'info'
				);

				const confirmed = confirm(
					`updateBookingStatus: Are you sure you want to change booking #${bookingId} status to "${newStatus}"?`
				);
				if (confirmed) {
					logEvent(
						`Status update confirmed via updateBookingStatus`,
						'info'
					);
					showTestResult();
				} else {
					logEvent(
						`Status update cancelled via updateBookingStatus`,
						'warning'
					);
					document.getElementById('testStatusSelect').value =
						document.getElementById(
							'testStatusSelect'
						).dataset.currentStatus;
				}
			}

			function showTestResult() {
				const result = document.getElementById('testResult');
				result.style.display = 'block';

				if (confirmationCount === 1) {
					result.className = 'test-result success';
					result.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <strong>TEST PASSED!</strong> Only 1 confirmation dialog appeared as expected.
                `;
				} else {
					result.className = 'test-result error';
					result.innerHTML = `
                    <i class="fas fa-times-circle"></i>
                    <strong>TEST FAILED!</strong> ${confirmationCount} confirmation dialogs appeared instead of 1.
                `;
				}
			}

			function runAutomatedTest() {
				clearLog();
				logEvent('Starting automated test...', 'info');

				// Simulate the initialization that happens in admin.js
				logEvent('Simulating admin.js initialization...');
				initializeStatusUpdates();
				initializeBulkBookingSelection();

				// Simulate a status change
				setTimeout(() => {
					logEvent('Triggering automated status change...');
					const select = document.getElementById('testStatusSelect');
					select.value = 'confirmed';
					select.dispatchEvent(new Event('change'));
				}, 1000);
			}

			// Initialize when page loads
			document.addEventListener('DOMContentLoaded', function () {
				logEvent(
					'Page loaded - Click "Run Automated Test" or manually change the status dropdown'
				);

				// Initialize the functions that would normally be called by admin.js
				initializeStatusUpdates();
				initializeBulkBookingSelection();
			});
		</script>
	</body>
</html>
